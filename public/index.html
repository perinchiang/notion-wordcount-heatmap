<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Notion Task Heatmap</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap/cal-heatmap.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
    </style>
</head>
<body>

    <div id="cal-heatmap"></div>

    <script src="https://cdn.jsdelivr.net/npm/d3@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap/cal-heatmap.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const baseUrl = window.location.origin;
            
            // --- ğŸ’¡ è‡ªåŠ¨è®¡ç®—èµ·å§‹æ—¥æœŸé€»è¾‘ ---
            // è·å–å½“å‰æ—¶é—´
            var now = new Date();
            // å¤åˆ¶ä¸€ä»½æ—¶é—´å¯¹è±¡ç”¨æ¥åšè®¡ç®—
            var startDate = new Date(now);
            // å¾€å‰æ¨ 5 ä¸ªæœˆ (åŠ ä¸Šæœ¬æœˆå°±æ˜¯æ˜¾ç¤º 6 ä¸ªæœˆ)
            startDate.setMonth(now.getMonth() - 5);

            // åˆå§‹åŒ–çƒ­åŠ›å›¾
            const cal = new CalHeatMap();
            cal.init({
                itemSelector: "#cal-heatmap",
                domain: "month",      // å¤§æ ¼å­æ˜¯æœˆä»½
                subDomain: "day",     // å°æ ¼å­æ˜¯å¤©
                
                // --- å…³é”®é…ç½® 1: åŠ¨æ€æ—¥æœŸ ---
                start: startDate,     // åŠ¨æ€èµ·å§‹æ—¥æœŸ
                range: 6,             // æ˜¾ç¤º 6 ä¸ªæœˆ
                
                // --- å…³é”®é…ç½® 2: æ•°æ®æº ---
                data: baseUrl + "/api/database",
                dataType: "json",     // æ˜¾å¼æŒ‡å®šæ•°æ®ç±»å‹

                cellSize: 12,
                cellPadding: 2,
                domainGutter: 10,     // æœˆä»½ä¹‹é—´çš„é—´è·
                
                // --- å…³é”®é…ç½® 3: é¢œè‰²é˜ˆå€¼ ---
                // 1å­—å˜æµ…ç»¿ï¼Œ200å­—å˜ä¸­ç»¿ï¼Œ500å­—å˜æ·±ç»¿ï¼Œ1000å­—å˜æœ€æ·±ç»¿
                legend: [1, 200, 500, 1000],
                
                // è‡ªå®šä¹‰é¢œè‰² (ç±»ä¼¼ GitHub é£æ ¼)
                legendColors: {
                    min: "#9be9a8",   // <--- ä¿®æ”¹è¿™é‡Œï¼æŠŠä¹‹å‰çš„ç°è‰²æ”¹æˆæµ…ç»¿è‰²
                    max: "#216e39",   // æ·±ç»¿è‰²
                    empty: "#ebedf0"  // æ²¡æ•°æ®çš„æ—¥å­æ˜¾ç¤ºç°è‰²
                },

                // é¼ æ ‡æ‚¬åœæç¤º
                tooltip: true,
                subDomainTitleFormat: {
                    empty: "{date}: æ‘¸é±¼ (0å­—)",
                    filled: "{date}: {count} å­—"
                },
                
                // æ•°æ®åŠ è½½åçš„å¤„ç† (å°† YYYY-MM-DD è½¬ä¸ºç§’çº§æ—¶é—´æˆ³)
                afterLoadData: function(data) {
                    // å¦‚æœåç«¯è¿”å›ç©ºï¼Œç›´æ¥è¿”å›ç©ºå¯¹è±¡
                    if (!data || data.length === 0) {
                        console.warn("åç«¯è¿”å›æ•°æ®ä¸ºç©º");
                        return {};
                    }

                    var result = {};
                    data.forEach(function(item) {
                        // å°†åç«¯è¿”å›çš„æ—¥æœŸå­—ç¬¦ä¸² (2026-01-01) è½¬æ¢ä¸ºç§’çº§æ—¶é—´æˆ³
                        var dateTimestamp = Math.floor(new Date(item.date).getTime() / 1000);
                        result[dateTimestamp] = item.count;
                    });
                    return result;
                }
            });

            // æ¯ 60 ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡æ•°æ®
            setInterval(function() {
                cal.update(baseUrl + "/api/database");
            }, 60000);
        });
    </script>
</body>
</html>


